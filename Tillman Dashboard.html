<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tillman Fiber Project Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #1f2937; font-size: 28px; font-weight: bold; }
        .header p { color: #6b7280; margin-top: 5px; }
        .last-updated { background: #3b82f6; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; }
        .controls { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .control-group label { display: block; font-weight: 500; color: #374151; margin-bottom: 5px; font-size: 14px; }
        .control-group select, .control-group input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-header { display: flex; align-items: center; margin-bottom: 10px; }
        .stat-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .chart-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #8b5cf6); }
        .chart-card h3 { margin-bottom: 15px; color: #1f2937; font-size: 18px; font-weight: 600; }
        .chart-container { position: relative; height: 300px; }
        .table-card { background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .table-card h3 { padding: 20px; margin: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .table-container { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 500; color: #374151; border-bottom: 1px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-process { background: #fef3c7; color: #92400e; }
        .status-not-started { background: #fee2e2; color: #991b1b; }
        .status-other { background: #f3f4f6; color: #374151; }
        .progress-bar { width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .progress-high { background: #10b981; }
        .progress-medium { background: #3b82f6; }
        .progress-low { background: #f59e0b; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn:hover { opacity: 0.9; }
        .error { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .loading { color: #3b82f6; font-size: 14px; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Tillman Fiber Project Dashboard</h1>
                <p>Construction Management System</p>
            </div>
            <div class="last-updated">
                <div style="font-weight: 500;">Last Updated</div>
                <div style="font-size: 12px;" id="lastUpdated"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Supervisor</label>
                    <select id="supervisorFilter">
                        <option value="All">All Supervisors</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Area</label>
                    <select id="areaFilter">
                        <option value="All">All Areas</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Status</label>
                    <select id="statusFilter">
                        <option value="All">All Statuses</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Update Data</label>
                    <input type="file" id="fileInput" accept=".csv,.txt,.tsv">
                    <span id="uploadStatus" class="loading" style="display: none;">Processing...</span>
                </div>
                <div class="control-group">
                    <label>Data Actions</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                        <button class="btn btn-success" onclick="exportData()">üì• Export</button>
                    </div>
                </div>
            </div>
            <div id="errorMessage" class="error" style="display: none;"></div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #dbeafe; color: #1e40af;">üìä</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Total Projects</div>
                        <div class="stat-value" style="color: #1e40af;" id="totalProjects">0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #dcfce7; color: #16a34a;">üí∞</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Total Cost</div>
                        <div class="stat-value" style="color: #16a34a;" id="totalCost">$0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #fef3c7; color: #d97706;">üìè</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Total Footage</div>
                        <div class="stat-value" style="color: #d97706;" id="totalFootage">0 ft</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #f3e8ff; color: #9333ea;">‚úì</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Completion Rate</div>
                        <div class="stat-value" style="color: #9333ea;" id="completionRate">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>Project Status Distribution</h3>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Supervisor Workload</h3>
                <div class="chart-container">
                    <canvas id="supervisorChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Completion Progress by Area</h3>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Cost vs Completion Analysis</h3>
                <div class="chart-container">
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Monthly Project Timeline</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>Project Performance Metrics</h3>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Projects Table -->
        <div class="table-card">
            <h3>Project Details</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>NTP Number</th>
                            <th>Area</th>
                            <th>Supervisor</th>
                            <th>Vendor</th>
                            <th>Cost</th>
                            <th>Status</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody id="projectsTable">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = [];
        let filteredData = [];
        let charts = {};

        // Initialize the application
        async function init() {
            if (typeof Chart === 'undefined') {
                setTimeout(init, 100);
                return;
            }
            
            await loadDataFromFile();
            setupEventListeners();
            updateLastUpdated();
            updateFilters();
            updateDashboard();
        }

        // Load data from CSV file
        async function loadDataFromFile() {
            try {
                const fileContent = await window.fs.readFile('tillman-project.csv', { encoding: 'utf8' });
                await parseCSVData(fileContent);
                console.log(`Loaded ${currentData.length} projects from CSV file`);
            } catch (error) {
                console.warn('Could not load CSV file from memory:', error.message);
                loadDataFromStorage();
            }
        }

        // Parse CSV data
        async function parseCSVData(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('CSV file must contain at least a header row and one data row.');
            }

            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };

            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                if (row['NTP Number'] && row['NTP Number'].trim() !== '') {
                    const cleanRow = {
                        "NTP Number": row["NTP Number"] || "",
                        "AREA": row["AREA"] || "",
                        "SOW TSD Date": row["SOW TSD Date"] || "",
                        "Vendor Assignment": row["Vendor Assignment"] || "",
                        "Date Assigned": row["Date Assigned"] || "",
                        "Assigned Supervisor": row["Assigned Supervisor"] || "",
                        "SOW Estimated Cost": row["SOW Estimated Cost"] || "",
                        "Constuction Status": row["Constuction Status"] || "",
                        "Footage UG": row["Footage UG"] || "",
                        "Actual Redline Completed Footage UG": row["Actual Redline Completed Footage UG"] || "",
                        "UG Percentage Complete": row["UG Percentage Complete"] || "0%"
                    };
                    data.push(cleanRow);
                }
            }

            if (data.length === 0) {
                throw new Error('No valid project data found in CSV file.');
            }

            currentData = data;
            filteredData = [...currentData];
            saveDataToStorage();
        }

        // Load data from localStorage
        function loadDataFromStorage() {
            try {
                const saved = localStorage.getItem('tillman-project-data');
                if (saved) {
                    currentData = JSON.parse(saved);
                    filteredData = [...currentData];
                    console.log(`Loaded ${currentData.length} projects from localStorage`);
                } else {
                    currentData = [];
                    filteredData = [];
                    console.log('No data available - please upload a CSV file');
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                currentData = [];
                filteredData = [];
            }
        }

        // Save data to localStorage
        function saveDataToStorage() {
            try {
                localStorage.setItem('tillman-project-data', JSON.stringify(currentData));
                localStorage.setItem('tillman-last-updated', new Date().toISOString());
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
            }
        }

        // Refresh data
        async function refreshData() {
            const refreshButton = document.querySelector('button[onclick="refreshData()"]');
            const originalText = refreshButton.textContent;
            
            try {
                refreshButton.textContent = 'üîÑ Loading...';
                refreshButton.disabled = true;
                
                await loadDataFromFile();
                updateLastUpdated();
                updateFilters();
                updateDashboard();
                
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#d1fae5';
                errorMessage.style.color = '#065f46';
                errorMessage.textContent = `‚úÖ Successfully refreshed ${currentData.length} projects from CSV file`;
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                errorMessage.textContent = `Error refreshing data: ${error.message}`;
            } finally {
                refreshButton.textContent = originalText;
                refreshButton.disabled = false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('supervisorFilter').addEventListener('change', applyFilters);
            document.getElementById('areaFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const saved = localStorage.getItem('tillman-last-updated');
            const date = saved ? new Date(saved) : new Date();
            document.getElementById('lastUpdated').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Update filter options
        function updateFilters() {
            const supervisors = [...new Set(currentData.map(p => p['Assigned Supervisor']).filter(Boolean))].sort();
            const areas = [...new Set(currentData.map(p => p['AREA']).filter(Boolean))].sort();
            const statuses = [...new Set(currentData.map(p => p['Constuction Status']).filter(Boolean))].sort();

            updateSelectOptions('supervisorFilter', supervisors);
            updateSelectOptions('areaFilter', areas);
            updateSelectOptions('statusFilter', statuses);
        }

        // Update select options
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            select.innerHTML = `<option value="All">${select.querySelector('option').textContent}</option>`;
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply filters
        function applyFilters() {
            const supervisorFilter = document.getElementById('supervisorFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredData = currentData.filter(project => {
                return (supervisorFilter === 'All' || project['Assigned Supervisor'] === supervisorFilter) &&
                       (areaFilter === 'All' || project['AREA'] === areaFilter) &&
                       (statusFilter === 'All' || project['Constuction Status'] === statusFilter);
            });

            updateDashboard();
        }

        // Update entire dashboard
        function updateDashboard() {
            updateStats();
            updateCharts();
            updateTable();
        }

        // Update statistics
        function updateStats() {
            const totalProjects = filteredData.length;
            const totalCost = filteredData.reduce((sum, project) => {
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                return sum + cost;
            }, 0);
            const totalFootage = filteredData.reduce((sum, project) => {
                const footage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                return sum + footage;
            }, 0);
            const completedFootage = filteredData.reduce((sum, project) => {
                const footage = parseFloat((project['Actual Redline Completed Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                return sum + footage;
            }, 0);
            const completionRate = totalFootage > 0 ? (completedFootage / totalFootage) * 100 : 0;

            document.getElementById('totalProjects').textContent = totalProjects.toLocaleString();
            document.getElementById('totalCost').textContent = formatCurrency(totalCost);
            document.getElementById('totalFootage').textContent = formatNumber(totalFootage) + ' ft';
            document.getElementById('completionRate').textContent = completionRate.toFixed(1) + '%';
        }

        // Update all charts
        function updateCharts() {
            if (typeof Chart !== 'undefined') {
                updateStatusChart();
                updateSupervisorChart();
                updateProgressChart();
                updateScatterChart();
                updateTimelineChart();
                updateRadarChart();
            }
        }

        // Status chart
        function updateStatusChart() {
            const statusCounts = {};
            filteredData.forEach(project => {
                const status = project['Constuction Status'] || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const colors = labels.map(status => {
                switch (status) {
                    case 'Completed': return '#10b981';
                    case 'In Process': return '#f59e0b';
                    case 'Not Started': return '#ef4444';
                    case 'Locates Called': return '#8b5cf6';
                    default: return '#6b7280';
                }
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.statusChart) {
                charts.statusChart.destroy();
            }

            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Supervisor chart
        function updateSupervisorChart() {
            const supervisorStats = {};
            filteredData.forEach(project => {
                const supervisor = project['Assigned Supervisor'] || 'Unassigned';
                if (!supervisorStats[supervisor]) {
                    supervisorStats[supervisor] = { projects: 0, cost: 0 };
                }
                supervisorStats[supervisor].projects += 1;
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                supervisorStats[supervisor].cost += cost;
            });

            const labels = Object.keys(supervisorStats);
            const projectData = labels.map(supervisor => supervisorStats[supervisor].projects);

            const ctx = document.getElementById('supervisorChart').getContext('2d');
            
            if (charts.supervisorChart) {
                charts.supervisorChart.destroy();
            }

            charts.supervisorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Project Count',
                        data: projectData,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Progress chart
        function updateProgressChart() {
            const areaStats = {};
            filteredData.forEach(project => {
                const area = project['AREA'] || 'Unknown';
                if (!areaStats[area]) {
                    areaStats[area] = { totalFootage: 0, completedFootage: 0 };
                }
                const totalFootage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                const completedFootage = parseFloat((project['Actual Redline Completed Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                areaStats[area].totalFootage += totalFootage;
                areaStats[area].completedFootage += completedFootage;
            });

            const labels = Object.keys(areaStats);
            const completionData = labels.map(area => {
                const stats = areaStats[area];
                return stats.totalFootage > 0 ? (stats.completedFootage / stats.totalFootage) * 100 : 0;
            });

            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (charts.progressChart) {
                charts.progressChart.destroy();
            }

            charts.progressChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{
                        data: completionData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    animation: {
                        duration: 2000
                    }
                }
            });
        }

        // Scatter chart
        function updateScatterChart() {
            const scatterData = filteredData.map(project => {
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                return { x: cost, y: completion };
            }).filter(point => point.x > 0);

            const ctx = document.getElementById('scatterChart').getContext('2d');
            
            if (charts.scatterChart) {
                charts.scatterChart.destroy();
            }

            charts.scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Projects',
                        data: scatterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgb(59, 130, 246)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Cost ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Completion (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Timeline chart
        function updateTimelineChart() {
            const monthlyData = {};
            
            filteredData.forEach(project => {
                const dateStr = project['Date Assigned'] || project['SOW TSD Date'] || '';
                if (dateStr) {
                    try {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            const monthKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = { assigned: 0, completed: 0 };
                            }
                            monthlyData[monthKey].assigned += 1;
                            if (project['Constuction Status'] === 'Completed') {
                                monthlyData[monthKey].completed += 1;
                            }
                        }
                    } catch (e) {
                        // Skip invalid dates
                    }
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b));
            const assignedData = sortedMonths.map(month => monthlyData[month].assigned);
            const completedData = sortedMonths.map(month => monthlyData[month].completed);

            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timelineChart) {
                charts.timelineChart.destroy();
            }

            charts.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'Projects Assigned',
                            data: assignedData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Projects Completed',
                            data: completedData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Radar chart
        function updateRadarChart() {
            const supervisorPerformance = {};
            
            filteredData.forEach(project => {
                const supervisor = project['Assigned Supervisor'] || 'Unassigned';
                if (!supervisorPerformance[supervisor]) {
                    supervisorPerformance[supervisor] = {
                        projectCount: 0,
                        totalCost: 0,
                        completedProjects: 0,
                        avgFootage: 0
                    };
                }
                
                const perf = supervisorPerformance[supervisor];
                perf.projectCount += 1;
                
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                perf.totalCost += cost;
                
                const footage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                perf.avgFootage += footage;
                
                if (project['Constuction Status'] === 'Completed') {
                    perf.completedProjects += 1;
                }
            });

            const topSupervisors = Object.entries(supervisorPerformance)
                .filter(([name, _]) => name !== 'Unassigned')
                .sort(([,a], [,b]) => b.projectCount - a.projectCount)
                .slice(0, 3);

            if (topSupervisors.length === 0) {
                return;
            }

            const maxValues = {
                projectCount: Math.max(...Object.values(supervisorPerformance).map(p => p.projectCount)),
                totalCost: Math.max(...Object.values(supervisorPerformance).map(p => p.totalCost)),
                completionRate: 100,
                avgFootage: Math.max(...Object.values(supervisorPerformance).map(p => p.avgFootage / p.projectCount))
            };

            const datasets = topSupervisors.map(([name, perf], index) => {
                const colors = ['rgba(59, 130, 246, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(245, 158, 11, 0.6)'];
                const borderColors = ['rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)'];
                
                const completionRate = perf.projectCount > 0 ? (perf.completedProjects / perf.projectCount) * 100 : 0;
                const avgFootage = perf.projectCount > 0 ? perf.avgFootage / perf.projectCount : 0;
                
                return {
                    label: name,
                    data: [
                        (perf.projectCount / maxValues.projectCount) * 100,
                        (perf.totalCost / maxValues.totalCost) * 100,
                        completionRate,
                        (avgFootage / maxValues.avgFootage) * 100
                    ],
                    backgroundColor: colors[index],
                    borderColor: borderColors[index],
                    borderWidth: 2
                };
            });

            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (charts.radarChart) {
                charts.radarChart.destroy();
            }

            charts.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Project Volume', 'Total Cost', 'Completion Rate', 'Avg Footage'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    animation: {
                        duration: 2000
                    }
                }
            });
        }

        // Update projects table
        function updateTable() {
            const tbody = document.getElementById('projectsTable');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center; color: #6b7280; font-style: italic; padding: 40px;">No project data available. Please upload a CSV file or click Refresh to load data.</td>`;
                tbody.appendChild(row);
                return;
            }

            filteredData.slice(0, 50).forEach(project => {
                const row = document.createElement('tr');
                const completionPercent = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;

                row.innerHTML = `
                    <td>${project['NTP Number'] || ''}</td>
                    <td>${project['AREA'] || ''}</td>
                    <td>${project['Assigned Supervisor'] || ''}</td>
                    <td>${project['Vendor Assignment'] || ''}</td>
                    <td>${formatCurrency(cost)}</td>
                    <td><span class="status-badge ${getStatusClass(project['Constuction Status'])}">${project['Constuction Status'] || ''}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="progress-bar">
                                <div class="progress-fill ${getProgressClass(completionPercent)}" style="width: ${Math.min(completionPercent, 100)}%"></div>
                            </div>
                            <span style="font-size: 12px;">${project['UG Percentage Complete'] || '0%'}</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (filteredData.length > 50) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center; color: #6b7280; font-style: italic;">Showing first 50 of ${filteredData.length} projects. Use filters to refine results.</td>`;
                tbody.appendChild(row);
            }
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch (status) {
                case 'Completed': return 'status-completed';
                case 'In Process': return 'status-process';
                case 'Not Started': return 'status-not-started';
                default: return 'status-other';
            }
        }

        // Get progress CSS class
        function getProgressClass(percent) {
            if (percent >= 70) return 'progress-high';
            if (percent >= 30) return 'progress-medium';
            return 'progress-low';
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadStatus = document.getElementById('uploadStatus');
            const errorMessage = document.getElementById('errorMessage');
            
            uploadStatus.style.display = 'inline';
            errorMessage.style.display = 'none';

            try {
                const text = await file.text();
                await parseCSVData(text);
                
                updateLastUpdated();
                updateFilters();
                updateDashboard();
                
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#d1fae5';
                errorMessage.style.color = '#065f46';
                errorMessage.textContent = `‚úÖ Successfully loaded ${currentData.length} projects from uploaded file`;
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                uploadStatus.style.display = 'none';
                event.target.value = '';
            }
        }

        // Export data to CSV
        function exportData() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => 
                    headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tillman-projects-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Utility functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(num) {
            return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>