<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tillman Fiber Project Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #1f2937; font-size: 28px; font-weight: bold; }
        .header p { color: #6b7280; margin-top: 5px; }
        .last-updated { background: #3b82f6; color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; }
        .controls { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .control-group label { display: block; font-weight: 500; color: #374151; margin-bottom: 5px; font-size: 14px; }
        .control-group select, .control-group input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-header { display: flex; align-items: center; margin-bottom: 10px; }
        .stat-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .chart-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #8b5cf6); }
        .chart-card h3 { margin-bottom: 15px; color: #1f2937; font-size: 18px; font-weight: 600; }
        .chart-container { position: relative; height: 300px; }
        .table-card { background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .table-card h3 { padding: 20px; margin: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; }
        .table-container { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 500; color: #374151; border-bottom: 1px solid #e5e7eb; }
        td { padding: 12px; border-bottom: 1px solid #f3f4f6; }
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-process { background: #fef3c7; color: #92400e; }
        .status-not-started { background: #fee2e2; color: #991b1b; }
        .status-other { background: #f3f4f6; color: #374151; }
        .progress-bar { width: 60px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .progress-high { background: #10b981; }
        .progress-medium { background: #3b82f6; }
        .progress-low { background: #f59e0b; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn:hover { opacity: 0.9; }
        .error { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .loading { color: #3b82f6; font-size: 14px; margin-left: 10px; }
        .tab-navigation { 
            display: flex; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 30px; 
            overflow: hidden; 
        }
        .tab-button { 
            flex: 1; 
            padding: 15px 20px; 
            border: none; 
            background: transparent; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 500; 
            color: #6b7280; 
            transition: all 0.3s ease; 
            border-bottom: 3px solid transparent; 
        }
        .tab-button:hover { 
            background: #f9fafb; 
            color: #3b82f6; 
        }
        .tab-button.active { 
            color: #3b82f6; 
            background: #f9fafb; 
            border-bottom-color: #3b82f6; 
        }
        .tab-content { 
            display: none; 
        }
        .tab-content.active { 
            display: block; 
        }
        .timeline-stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .performance-stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>Tillman Fiber Project Dashboard</h1>
                <p>Construction Management System</p>
            </div>
            <div class="last-updated">
                <div style="font-weight: 500;">Last Updated</div>
                <div style="font-size: 12px;" id="lastUpdated"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Supervisor</label>
                    <select id="supervisorFilter">
                        <option value="All">All Supervisors</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Area</label>
                    <select id="areaFilter">
                        <option value="All">All Areas</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Status</label>
                    <select id="statusFilter">
                        <option value="All">All Statuses</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Update Data</label>
                    <input type="file" id="fileInput" accept=".csv,.txt,.tsv,.xlsx,.xls">
                    <span id="uploadStatus" class="loading" style="display: none;">Processing...</span>
                </div>
                <div class="control-group">
                    <label>Data Actions</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                        <button class="btn btn-success" onclick="exportData()">üì• Export</button>
                        <button class="btn" style="background: #ef4444; color: white;" onclick="clearLocalStorage()">üóëÔ∏è Clear Cache</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>Auto-Refresh</label>
                    <select id="autoRefreshSelect" onchange="setAutoRefresh()">
                        <option value="0">Manual Only</option>
                        <option value="30">Every 30 seconds</option>
                        <option value="60">Every 1 minute</option>
                        <option value="300">Every 5 minutes</option>
                        <option value="600">Every 10 minutes</option>
                        <option value="1800">Every 30 minutes</option>
                    </select>
                    <div id="autoRefreshStatus" style="font-size: 12px; color: #6b7280; margin-top: 4px;"></div>
                </div>
            </div>
            <div id="errorMessage" class="error" style="display: none;"></div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #dbeafe; color: #1e40af;">üìä</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Total Projects</div>
                        <div class="stat-value" style="color: #1e40af;" id="totalProjects">0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #dcfce7; color: #16a34a;">üí∞</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Total Cost</div>
                        <div class="stat-value" style="color: #16a34a;" id="totalCost">$0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #fef3c7; color: #d97706;">üìè</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Total Footage</div>
                        <div class="stat-value" style="color: #d97706;" id="totalFootage">0 ft</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon" style="background: #f3e8ff; color: #9333ea;">‚úì</div>
                    <div>
                        <div style="color: #6b7280; font-size: 14px;">Completion Rate</div>
                        <div class="stat-value" style="color: #9333ea;" id="completionRate">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('overview')">Overview</button>
            <button class="tab-button" onclick="switchTab('timeline')">Timeline</button>
            <button class="tab-button" onclick="switchTab('performance')">Performance</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content active">
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Project Status Distribution</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Supervisor Workload</h3>
                    <div class="chart-container">
                        <canvas id="supervisorChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Completion Progress by Area</h3>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Monthly Project Timeline</h3>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Tab -->
        <div id="timeline-tab" class="tab-content">
            <div class="timeline-stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #fee2e2; color: #dc2626;">‚ö†Ô∏è</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">Overdue Projects</div>
                            <div class="stat-value" style="color: #dc2626;" id="overdueProjects">0</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #fef3c7; color: #d97706;">‚è∞</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">At Risk Projects</div>
                            <div class="stat-value" style="color: #d97706;" id="atRiskProjects">0</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #dcfce7; color: #16a34a;">‚úÖ</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">On Track Projects</div>
                            <div class="stat-value" style="color: #16a34a;" id="onTrackProjects">0</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #ddd6fe; color: #7c3aed;">üìÖ</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">Avg Days to Complete</div>
                            <div class="stat-value" style="color: #7c3aed;" id="avgDaysComplete">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Project Timeline Status</h3>
                    <div class="chart-container">
                        <canvas id="timelineStatusChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Project Timeline Gantt</h3>
                    <div class="chart-container">
                        <canvas id="ganttChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Projects by Month</h3>
                    <div class="chart-container">
                        <canvas id="monthlyProjectsChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Completion Trends</h3>
                    <div class="chart-container">
                        <canvas id="completionTrendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Tab -->
        <div id="performance-tab" class="tab-content">
            <div class="performance-stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #dbeafe; color: #1e40af;">üìä</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">Average Completion Rate</div>
                            <div class="stat-value" style="color: #1e40af;" id="avgCompletionRate">0%</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #dcfce7; color: #16a34a;">‚è±Ô∏è</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">Projects on Schedule</div>
                            <div class="stat-value" style="color: #16a34a;" id="onScheduleProjects">0</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #fef3c7; color: #d97706;">üí∞</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">Cost per Foot</div>
                            <div class="stat-value" style="color: #d97706;" id="costPerFoot">$10.00</div>
                        </div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon" style="background: #f3e8ff; color: #9333ea;">üìè</div>
                        <div>
                            <div style="color: #6b7280; font-size: 14px;">Avg Project Size</div>
                            <div class="stat-value" style="color: #9333ea;" id="avgProjectSize">0 ft</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Cost vs Completion Analysis</h3>
                    <div class="chart-container">
                        <canvas id="scatterChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Project Performance Metrics</h3>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Supervisor Performance</h3>
                    <div class="chart-container">
                        <canvas id="supervisorPerformanceChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Performance Metrics</h3>
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Projects Table -->
            <div class="table-card">
                <h3>Project Details</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>NTP Number</th>
                                <th>Area</th>
                                <th>Supervisor</th>
                                <th>Vendor</th>
                                <th>Cost</th>
                                <th>Status</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTable">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentData = [];
        let filteredData = [];
        let charts = {};
        let autoRefreshInterval = null;
        let autoRefreshCountdown = null;

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Update charts for the active tab
            setTimeout(() => {
                updateTabSpecificCharts(tabName);
            }, 100);
        }

        // Update charts specific to each tab
        function updateTabSpecificCharts(tabName) {
            if (typeof Chart === 'undefined') return;
            
            switch(tabName) {
                case 'overview':
                    updateStatusChart();
                    updateSupervisorChart();
                    updateProgressChart();
                    updateTimelineChart();
                    break;
                case 'timeline':
                    updateTimelineStats();
                    updateTimelineStatusChart();
                    updateGanttChart();
                    updateMonthlyProjectsChart();
                    updateCompletionTrendsChart();
                    break;
                case 'performance':
                    updatePerformanceStats();
                    updateScatterChart();
                    updateRadarChart();
                    updateSupervisorPerformanceChart();
                    updateEfficiencyChart();
                    updateTable();
                    break;
            }
        }

        // Initialize the application
        async function init() {
            if (typeof Chart === 'undefined') {
                setTimeout(init, 100);
                return;
            }
            
            await loadDataFromFile();
            setupEventListeners();
            updateLastUpdated();
            updateFilters();
            updateDashboard();
            checkDataAge(); // Check if data is stale
        }

        // Check if localStorage data is stale and needs refreshing
        function checkDataAge() {
            const lastUpdated = localStorage.getItem('tillman-last-updated');
            if (lastUpdated) {
                const lastUpdatedDate = new Date(lastUpdated);
                const now = new Date();
                const hoursSinceUpdate = (now - lastUpdatedDate) / (1000 * 60 * 60);
                
                // Show warning if data is older than 4 hours
                if (hoursSinceUpdate > 4) {
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.style.display = 'block';
                    errorMessage.style.background = '#fef3c7';
                    errorMessage.style.color = '#92400e';
                    errorMessage.textContent = `‚ö†Ô∏è Data is ${Math.round(hoursSinceUpdate)} hours old. Consider refreshing for latest information.`;
                    
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 8000);
                }
            }
        }

        // Clear localStorage cache
        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all cached data? This will remove stored project data and you\'ll need to upload a file again.')) {
                localStorage.removeItem('tillman-project-data');
                localStorage.removeItem('tillman-last-updated');
                currentData = [];
                filteredData = [];
                updateDashboard();
                
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#d1fae5';
                errorMessage.style.color = '#065f46';
                errorMessage.textContent = '‚úÖ Cache cleared successfully. Please upload a new data file.';
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
            }
        }

        // Set up auto-refresh functionality
        function setAutoRefresh() {
            const select = document.getElementById('autoRefreshSelect');
            const seconds = parseInt(select.value);
            const statusDiv = document.getElementById('autoRefreshStatus');
            
            // Clear existing intervals
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (autoRefreshCountdown) {
                clearInterval(autoRefreshCountdown);
                autoRefreshCountdown = null;
            }
            
            if (seconds > 0) {
                let remainingSeconds = seconds;
                
                // Set up the refresh interval
                autoRefreshInterval = setInterval(async () => {
                    console.log('Auto-refreshing data...');
                    try {
                        await refreshData();
                    } catch (error) {
                        console.error('Auto-refresh failed:', error);
                    }
                    remainingSeconds = seconds; // Reset countdown
                }, seconds * 1000);
                
                // Set up the countdown display
                autoRefreshCountdown = setInterval(() => {
                    remainingSeconds--;
                    if (remainingSeconds <= 0) {
                        remainingSeconds = seconds;
                    }
                    
                    const minutes = Math.floor(remainingSeconds / 60);
                    const secs = remainingSeconds % 60;
                    const timeStr = minutes > 0 ? `${minutes}m ${secs}s` : `${secs}s`;
                    statusDiv.textContent = `Next refresh in: ${timeStr}`;
                }, 1000);
                
                statusDiv.textContent = `Auto-refresh enabled (${formatRefreshInterval(seconds)})`;
            } else {
                statusDiv.textContent = '';
            }
            
            // Save preference
            localStorage.setItem('auto-refresh-interval', seconds.toString());
        }

        // Format refresh interval for display
        function formatRefreshInterval(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${seconds / 60}m`;
            return `${seconds / 3600}h`;
        }

        // Load auto-refresh preference on startup
        function loadAutoRefreshPreference() {
            const saved = localStorage.getItem('auto-refresh-interval');
            if (saved) {
                const select = document.getElementById('autoRefreshSelect');
                select.value = saved;
                setAutoRefresh();
            }
        }

        // Load data from Excel or CSV file
        async function loadDataFromFile() {
            try {
                // Only try to fetch files if we're on http/https (not file://)
                if (window.location.protocol === 'file:') {
                    console.log('Running from file:// - skipping automatic file fetch. Please use the file upload feature.');
                    loadDataFromStorage();
                    return;
                }
                
                // Try to fetch Excel file first, then CSV
                let response;
                let fileContent;
                let isExcel = false;
                
                try {
                    response = await fetch('./tillman-project.xlsx');
                    if (response.ok) {
                        fileContent = await response.arrayBuffer();
                        isExcel = true;
                    }
                } catch (e) {
                    // Try CSV if Excel fails
                    response = await fetch('./tillman-project.csv');
                    if (response.ok) {
                        fileContent = await response.text();
                        isExcel = false;
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                if (isExcel) {
                    await parseExcelData(fileContent);
                } else {
                    await parseCSVData(fileContent);
                }
                
                console.log(`Loaded ${currentData.length} projects from ${isExcel ? 'Excel' : 'CSV'} file`);
            } catch (error) {
                console.warn('Could not load data file:', error.message);
                loadDataFromStorage();
            }
        }

        // Parse Excel data with multiple sheet support
        async function parseExcelData(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                console.log('Workbook sheets:', workbook.SheetNames);
                
                let worksheet = null;
                let sheetName = '';
                
                // Try to find the right sheet - look for sheets with project data
                for (const name of workbook.SheetNames) {
                    const testSheet = workbook.Sheets[name];
                    const testData = XLSX.utils.sheet_to_json(testSheet, { header: 1 });
                    
                    if (testData.length > 0 && testData[0]) {
                        const headers = testData[0].map(h => (h || '').toString().toLowerCase());
                        
                        // Look for project-related headers
                        const hasProjectHeaders = headers.some(h => 
                            h.includes('ntp') || 
                            h.includes('area') || 
                            h.includes('supervisor') || 
                            h.includes('vendor') ||
                            h.includes('status') ||
                            h.includes('footage')
                        );
                        
                        if (hasProjectHeaders) {
                            worksheet = testSheet;
                            sheetName = name;
                            console.log(`Using sheet: ${name}`);
                            break;
                        }
                    }
                }
                
                // If no project sheet found, use first sheet
                if (!worksheet) {
                    sheetName = workbook.SheetNames[0];
                    worksheet = workbook.Sheets[sheetName];
                    console.log(`No project sheet found, using first sheet: ${sheetName}`);
                }
                
                // Convert to JSON with date handling
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    dateNF: 'MM/DD/YYYY',  // Format dates consistently
                    cellDates: true,       // Parse dates as Date objects
                    raw: false            // Don't use raw values, format them
                });
                
                console.log(`Sheet "${sheetName}" - Excel data rows:`, jsonData.length);
                
                if (jsonData.length < 2) {
                    throw new Error(`Sheet "${sheetName}" must contain at least a header row and one data row. Found ${jsonData.length} rows.`);
                }
                
                const headers = jsonData[0];
                console.log('Headers:', headers);
                
                // Check if this looks like a summary/report sheet rather than project data
                const headerStr = headers.join(' ').toLowerCase();
                if (headerStr.includes('ytd') && headerStr.includes('jan') && headerStr.includes('feb')) {
                    throw new Error(`This appears to be a summary/report sheet (contains YTD, JAN, FEB columns). Please select the sheet with detailed project data containing columns like: NTP Number, Area, Supervisor, Status, etc.`);
                }
                
                console.log('First data row:', jsonData[1]);
                
                const data = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = {};
                    headers.forEach((header, index) => {
                        let value = jsonData[i][index];
                        
                        // Enhanced data type handling for Excel
                        if (value === null || value === undefined) {
                            value = '';
                        } else if (value instanceof Date) {
                            // Format dates consistently
                            value = value.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: '2-digit', 
                                day: '2-digit' 
                            });
                        } else if (typeof value === 'number') {
                            // Check if this is likely an Excel date number
                            const headerLower = (header || '').toString().toLowerCase();
                            if (headerLower.includes('date') && value > 40000 && value < 50000) {
                                // Excel date serial number - convert to proper date
                                const excelDate = XLSX.SSF.parse_date_code(value);
                                if (excelDate) {
                                    const jsDate = new Date(excelDate.y, excelDate.m - 1, excelDate.d);
                                    value = jsDate.toLocaleDateString('en-US', { 
                                        year: 'numeric', 
                                        month: '2-digit', 
                                        day: '2-digit' 
                                    });
                                } else {
                                    value = value.toString();
                                }
                            } else if (headerLower.includes('cost') || headerLower.includes('footage')) {
                                // Keep numbers as strings but format properly
                                value = value.toString();
                            } else {
                                value = value.toString();
                            }
                        } else {
                            value = value.toString().trim();
                        }
                        
                        row[header] = value;
                    });
                    
                    // More flexible check for valid rows - look for any of these key fields
                    const ntpNumber = row['NTP Number'] || row['NTP'] || row['Number'] || '';
                    const area = row['AREA'] || row['Area'] || '';
                    const supervisor = row['Assigned Supervisor'] || row['Supervisor'] || '';
                    
                    const hasValidData = ntpNumber.toString().trim() !== '' || 
                                       area.toString().trim() !== '' ||
                                       supervisor.toString().trim() !== '';
                    
                    if (hasValidData) {
                        const cleanRow = {
                            "NTP Number": ntpNumber.toString(),
                            "AREA": area.toString(),
                            "SOW TSD Date": (row["SOW TSD Date"] || row["TSD Date"] || "").toString(),
                            "Vendor Assignment": (row["Vendor Assignment"] || row["Vendor"] || "").toString(),
                            "Date Assigned": (row["Date Assigned"] || row["Assigned Date"] || "").toString(),
                            "Assigned Supervisor": supervisor.toString(),
                            "SOW Estimated Cost": (row["SOW Estimated Cost"] || row["Cost"] || row["Estimated Cost"] || "").toString(),
                            "Constuction Status": (row["Constuction Status"] || row["Construction Status"] || row["Status"] || "").toString(),
                            "Footage UG": (row["Footage UG"] || row["Footage"] || "").toString(),
                            "Actual Redline Completed Footage UG": (row["Actual Redline Completed Footage UG"] || row["Completed Footage"] || "").toString(),
                            "UG Percentage Complete": (row["UG Percentage Complete"] || row["Percentage Complete"] || row["Complete"] || "0%").toString()
                        };
                        
                        // Clean up percentage values
                        if (cleanRow["UG Percentage Complete"] && !cleanRow["UG Percentage Complete"].includes('%')) {
                            const numValue = parseFloat(cleanRow["UG Percentage Complete"]);
                            if (!isNaN(numValue)) {
                                // If it's a decimal (0.75), convert to percentage (75%)
                                if (numValue <= 1) {
                                    cleanRow["UG Percentage Complete"] = (numValue * 100) + '%';
                                } else {
                                    cleanRow["UG Percentage Complete"] = numValue + '%';
                                }
                            }
                        }
                        
                        data.push(cleanRow);
                        
                        // Log first few rows for debugging
                        if (data.length <= 3) {
                            console.log(`Row ${data.length}:`, cleanRow);
                        }
                    }
                }
                
                console.log(`Processed ${data.length} valid rows out of ${jsonData.length - 1} total rows`);
                
                // Remove duplicates based on NTP Number
                const uniqueData = [];
                const seenNTPs = new Set();
                const duplicates = [];
                
                data.forEach((project, index) => {
                    const ntpNumber = project['NTP Number'].toString().trim().toUpperCase();
                    
                    if (ntpNumber && ntpNumber !== '') {
                        if (seenNTPs.has(ntpNumber)) {
                            duplicates.push({
                                ntp: ntpNumber,
                                row: index + 2, // +2 because Excel is 1-indexed and we skip header
                                area: project['AREA']
                            });
                        } else {
                            seenNTPs.add(ntpNumber);
                            uniqueData.push(project);
                        }
                    } else {
                        // If no NTP number, keep it but check for other duplicates
                        uniqueData.push(project);
                    }
                });
                
                // Log duplicate information
                if (duplicates.length > 0) {
                    console.warn(`Found ${duplicates.length} duplicate projects:`, duplicates);
                    
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.style.display = 'block';
                    errorMessage.style.background = '#fef3c7';
                    errorMessage.style.color = '#92400e';
                    errorMessage.textContent = `‚ö†Ô∏è Removed ${duplicates.length} duplicate projects. Check console for details.`;
                    
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 5000);
                }
                
                console.log(`After duplicate removal: ${uniqueData.length} unique projects (removed ${data.length - uniqueData.length} duplicates)`);
                
                if (uniqueData.length === 0) {
                    throw new Error(`No valid project data found in sheet "${sheetName}". Found ${jsonData.length - 1} rows but none contained valid project data.\n\nAvailable headers: ${headers.join(', ')}\n\nExpected headers should include: NTP Number, Area, Supervisor, Status, etc.\n\nPlease check that you're using the correct sheet with detailed project data, not a summary report.`);
                }
                
                currentData = uniqueData;
                filteredData = [...currentData];
                saveDataToStorage();
                
            } catch (error) {
                console.error('Excel parsing error:', error);
                throw error;
            }
        }

        // Parse CSV data
        async function parseCSVData(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                throw new Error('CSV file must contain at least a header row and one data row.');
            }

            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            };

            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                if (row['NTP Number'] && row['NTP Number'].trim() !== '') {
                    const cleanRow = {
                        "NTP Number": row["NTP Number"] || "",
                        "AREA": row["AREA"] || "",
                        "SOW TSD Date": row["SOW TSD Date"] || "",
                        "Vendor Assignment": row["Vendor Assignment"] || "",
                        "Date Assigned": row["Date Assigned"] || "",
                        "Assigned Supervisor": row["Assigned Supervisor"] || "",
                        "SOW Estimated Cost": row["SOW Estimated Cost"] || "",
                        "Constuction Status": row["Constuction Status"] || "",
                        "Footage UG": row["Footage UG"] || "",
                        "Actual Redline Completed Footage UG": row["Actual Redline Completed Footage UG"] || "",
                        "UG Percentage Complete": row["UG Percentage Complete"] || "0%"
                    };
                    data.push(cleanRow);
                }
            }

            if (data.length === 0) {
                throw new Error('No valid project data found in CSV file.');
            }

            currentData = data;
            filteredData = [...currentData];
            
            // Remove duplicates based on NTP Number
            const uniqueData = [];
            const seenNTPs = new Set();
            const duplicates = [];
            
            data.forEach((project, index) => {
                const ntpNumber = project['NTP Number'].toString().trim().toUpperCase();
                
                if (ntpNumber && ntpNumber !== '') {
                    if (seenNTPs.has(ntpNumber)) {
                        duplicates.push({
                            ntp: ntpNumber,
                            row: index + 2, // +2 because we skip header
                            area: project['AREA']
                        });
                    } else {
                        seenNTPs.add(ntpNumber);
                        uniqueData.push(project);
                    }
                } else {
                    // If no NTP number, keep it but check for other duplicates
                    uniqueData.push(project);
                }
            });
            
            // Log duplicate information
            if (duplicates.length > 0) {
                console.warn(`Found ${duplicates.length} duplicate projects:`, duplicates);
                
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.style.display = 'block';
                    errorMessage.style.background = '#fef3c7';
                    errorMessage.style.color = '#92400e';
                    errorMessage.textContent = `‚ö†Ô∏è Removed ${duplicates.length} duplicate projects. Check console for details.`;
                    
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 5000);
                }
            }
            
            console.log(`After duplicate removal: ${uniqueData.length} unique projects (removed ${data.length - uniqueData.length} duplicates)`);
            
            currentData = uniqueData;
            filteredData = [...currentData];
            saveDataToStorage();
        }

        // Load data from localStorage
        function loadDataFromStorage() {
            try {
                const saved = localStorage.getItem('tillman-project-data');
                if (saved) {
                    currentData = JSON.parse(saved);
                    filteredData = [...currentData];
                    console.log(`Loaded ${currentData.length} projects from localStorage`);
                } else {
                    currentData = [];
                    filteredData = [];
                    console.log('No data available - please upload a CSV file');
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                currentData = [];
                filteredData = [];
            }
        }

        // Save data to localStorage
        function saveDataToStorage() {
            try {
                localStorage.setItem('tillman-project-data', JSON.stringify(currentData));
                localStorage.setItem('tillman-last-updated', new Date().toISOString());
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
            }
        }

        // Refresh data
        async function refreshData() {
            const refreshButton = document.querySelector('button[onclick="refreshData()"]');
            const originalText = refreshButton.textContent;
            
            try {
                refreshButton.textContent = 'üîÑ Loading...';
                refreshButton.disabled = true;
                
                // Force clear localStorage and reload fresh data
                localStorage.removeItem('tillman-project-data');
                localStorage.removeItem('tillman-last-updated');
                
                await loadDataFromFile();
                updateLastUpdated();
                updateFilters();
                updateDashboard();
                
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#d1fae5';
                errorMessage.style.color = '#065f46';
                errorMessage.textContent = `‚úÖ Successfully refreshed ${currentData.length} projects from data file`;
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'block';
                errorMessage.textContent = `Error refreshing data: ${error.message}`;
            } finally {
                refreshButton.textContent = originalText;
                refreshButton.disabled = false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('supervisorFilter').addEventListener('change', applyFilters);
            document.getElementById('areaFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Load auto-refresh preference after a short delay
            setTimeout(loadAutoRefreshPreference, 500);
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const saved = localStorage.getItem('tillman-last-updated');
            const date = saved ? new Date(saved) : new Date();
            document.getElementById('lastUpdated').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Update filter options
        function updateFilters() {
            const supervisors = [...new Set(currentData.map(p => p['Assigned Supervisor']).filter(Boolean))].sort();
            
            // Filter out invalid area values
            const areas = [...new Set(currentData.map(p => p['AREA']).filter(area => {
                if (!area) return false;
                const areaStr = area.toString().trim().toUpperCase();
                // Exclude generic terms that aren't actual areas
                return areaStr !== 'AREA' && 
                       areaStr !== '' && 
                       areaStr !== 'N/A' && 
                       areaStr !== 'NULL' &&
                       areaStr !== 'UNDEFINED' &&
                       areaStr.length > 1; // Exclude single characters
            }))].sort();
            
            const statuses = [...new Set(currentData.map(p => p['Constuction Status']).filter(Boolean))].sort();

            updateSelectOptions('supervisorFilter', supervisors);
            updateSelectOptions('areaFilter', areas);
            updateSelectOptions('statusFilter', statuses);
            
            // Log filtered areas for debugging
            console.log('Available areas for filtering:', areas);
        }

        // Update select options
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            select.innerHTML = `<option value="All">${select.querySelector('option').textContent}</option>`;
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });

            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply filters
        function applyFilters() {
            const supervisorFilter = document.getElementById('supervisorFilter').value;
            const areaFilter = document.getElementById('areaFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            filteredData = currentData.filter(project => {
                return (supervisorFilter === 'All' || project['Assigned Supervisor'] === supervisorFilter) &&
                       (areaFilter === 'All' || project['AREA'] === areaFilter) &&
                       (statusFilter === 'All' || project['Constuction Status'] === statusFilter);
            });

            updateDashboard();
        }

        // Update entire dashboard
        function updateDashboard() {
            updateStats();
            
            // Get current active tab
            const activeTab = document.querySelector('.tab-content.active').id.replace('-tab', '');
            updateTabSpecificCharts(activeTab);
        }

        // Update statistics
        function updateStats() {
            const totalProjects = filteredData.length;
            const totalCost = filteredData.reduce((sum, project) => {
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                return sum + cost;
            }, 0);
            const totalFootage = filteredData.reduce((sum, project) => {
                const footage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                return sum + footage;
            }, 0);
            const completedFootage = filteredData.reduce((sum, project) => {
                const footage = parseFloat((project['Actual Redline Completed Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                return sum + footage;
            }, 0);
            const completionRate = totalFootage > 0 ? (completedFootage / totalFootage) * 100 : 0;

            document.getElementById('totalProjects').textContent = totalProjects.toLocaleString();
            document.getElementById('totalCost').textContent = formatCurrency(totalCost);
            document.getElementById('totalFootage').textContent = formatNumber(totalFootage) + ' ft';
            document.getElementById('completionRate').textContent = completionRate.toFixed(1) + '%';
        }

        // Update timeline-specific statistics
        function updateTimelineStats() {
            const today = new Date();
            let overdueCount = 0;
            let atRiskCount = 0;
            let onTrackCount = 0;
            let totalDays = 0;
            let completedProjectsWithDates = 0;

            filteredData.forEach(project => {
                const assignedDate = project['Date Assigned'] ? new Date(project['Date Assigned']) : null;
                const status = project['Constuction Status'];
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                
                if (assignedDate && !isNaN(assignedDate.getTime())) {
                    const daysSinceAssigned = Math.floor((today - assignedDate) / (1000 * 60 * 60 * 24));
                    
                    if (status === 'Completed') {
                        totalDays += daysSinceAssigned;
                        completedProjectsWithDates++;
                        onTrackCount++;
                    } else if (status === 'Not Started' && daysSinceAssigned > 30) {
                        overdueCount++;
                    } else if (completion < 50 && daysSinceAssigned > 60) {
                        atRiskCount++;
                    } else if (status === 'In Process' || completion > 0) {
                        onTrackCount++;
                    }
                }
            });

            const avgDays = completedProjectsWithDates > 0 ? Math.round(totalDays / completedProjectsWithDates) : 0;

            document.getElementById('overdueProjects').textContent = overdueCount.toLocaleString();
            document.getElementById('atRiskProjects').textContent = atRiskCount.toLocaleString();
            document.getElementById('onTrackProjects').textContent = onTrackCount.toLocaleString();
            document.getElementById('avgDaysComplete').textContent = avgDays + ' days';
        }

        // Update performance-specific statistics
        function updatePerformanceStats() {
            const totalProjects = filteredData.length;
            
            // Average completion rate
            const avgCompletion = filteredData.length > 0 
                ? filteredData.reduce((sum, project) => {
                    const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                    return sum + completion;
                }, 0) / filteredData.length
                : 0;

            // Projects on schedule (completed or >50% complete within reasonable timeframe)
            const today = new Date();
            let onScheduleCount = 0;
            filteredData.forEach(project => {
                const assignedDate = project['Date Assigned'] ? new Date(project['Date Assigned']) : null;
                const status = project['Constuction Status'];
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                
                if (assignedDate && !isNaN(assignedDate.getTime())) {
                    const daysSinceAssigned = Math.floor((today - assignedDate) / (1000 * 60 * 60 * 24));
                    
                    if (status === 'Completed' || 
                        (completion >= 50 && daysSinceAssigned <= 90) ||
                        (completion >= 25 && daysSinceAssigned <= 45)) {
                        onScheduleCount++;
                    }
                }
            });

            // Average project size
            const avgProjectSize = filteredData.length > 0 
                ? filteredData.reduce((sum, project) => {
                    const footage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                    return sum + footage;
                }, 0) / filteredData.length
                : 0;

            document.getElementById('avgCompletionRate').textContent = avgCompletion.toFixed(1) + '%';
            document.getElementById('onScheduleProjects').textContent = onScheduleCount.toLocaleString();
            document.getElementById('costPerFoot').textContent = '$10.00';
            document.getElementById('avgProjectSize').textContent = formatNumber(Math.round(avgProjectSize)) + ' ft';
        }

        // Status chart
        function updateStatusChart() {
            const statusCounts = {};
            filteredData.forEach(project => {
                const status = project['Constuction Status'] || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const colors = labels.map(status => {
                switch (status) {
                    case 'Completed': return '#10b981';
                    case 'In Process': return '#f59e0b';
                    case 'Not Started': return '#ef4444';
                    case 'Locates Called': return '#8b5cf6';
                    default: return '#6b7280';
                }
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.statusChart) {
                charts.statusChart.destroy();
            }

            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Supervisor chart
        function updateSupervisorChart() {
            const supervisorStats = {};
            filteredData.forEach(project => {
                const supervisor = project['Assigned Supervisor'] || 'Unassigned';
                if (!supervisorStats[supervisor]) {
                    supervisorStats[supervisor] = { projects: 0, cost: 0 };
                }
                supervisorStats[supervisor].projects += 1;
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                supervisorStats[supervisor].cost += cost;
            });

            const labels = Object.keys(supervisorStats);
            const projectData = labels.map(supervisor => supervisorStats[supervisor].projects);

            const ctx = document.getElementById('supervisorChart').getContext('2d');
            
            if (charts.supervisorChart) {
                charts.supervisorChart.destroy();
            }

            charts.supervisorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Project Count',
                        data: projectData,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Progress chart
        function updateProgressChart() {
            const areaStats = {};
            filteredData.forEach(project => {
                const area = project['AREA'] || 'Unknown';
                if (!areaStats[area]) {
                    areaStats[area] = { totalFootage: 0, completedFootage: 0 };
                }
                const totalFootage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                const completedFootage = parseFloat((project['Actual Redline Completed Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                areaStats[area].totalFootage += totalFootage;
                areaStats[area].completedFootage += completedFootage;
            });

            const labels = Object.keys(areaStats);
            const completionData = labels.map(area => {
                const stats = areaStats[area];
                return stats.totalFootage > 0 ? (stats.completedFootage / stats.totalFootage) * 100 : 0;
            });

            const ctx = document.getElementById('progressChart').getContext('2d');
            
            if (charts.progressChart) {
                charts.progressChart.destroy();
            }

            charts.progressChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: labels,
                    datasets: [{
                        data: completionData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    animation: {
                        duration: 2000
                    }
                }
            });
        }

        // Timeline chart
        function updateTimelineChart() {
            const monthlyData = {};
            
            filteredData.forEach(project => {
                const dateStr = project['Date Assigned'] || project['SOW TSD Date'] || '';
                if (dateStr) {
                    try {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            const displayKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = { assigned: 0, completed: 0, display: displayKey };
                            }
                            monthlyData[monthKey].assigned += 1;
                            if (project['Constuction Status'] === 'Completed') {
                                monthlyData[monthKey].completed += 1;
                            }
                        }
                    } catch (e) {
                        // Skip invalid dates
                    }
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => monthlyData[key].display);
            const assignedData = sortedMonths.map(key => monthlyData[key].assigned);
            const completedData = sortedMonths.map(key => monthlyData[key].completed);

            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            if (charts.timelineChart) {
                charts.timelineChart.destroy();
            }

            charts.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Projects Assigned',
                            data: assignedData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Projects Completed',
                            data: completedData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Timeline status chart
        function updateTimelineStatusChart() {
            const today = new Date();
            const statusData = { overdue: 0, atRisk: 0, onTrack: 0 };

            filteredData.forEach(project => {
                const assignedDate = project['Date Assigned'] ? new Date(project['Date Assigned']) : null;
                const status = project['Constuction Status'];
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                
                if (assignedDate && !isNaN(assignedDate.getTime())) {
                    const daysSinceAssigned = Math.floor((today - assignedDate) / (1000 * 60 * 60 * 24));
                    
                    if (status === 'Not Started' && daysSinceAssigned > 30) {
                        statusData.overdue++;
                    } else if (completion < 50 && daysSinceAssigned > 60 && status !== 'Completed') {
                        statusData.atRisk++;
                    } else {
                        statusData.onTrack++;
                    }
                }
            });

            const ctx = document.getElementById('timelineStatusChart').getContext('2d');
            
            if (charts.timelineStatusChart) {
                charts.timelineStatusChart.destroy();
            }

            charts.timelineStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Overdue', 'At Risk', 'On Track'],
                    datasets: [{
                        data: [statusData.overdue, statusData.atRisk, statusData.onTrack],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Gantt chart (simplified timeline view)
        function updateGanttChart() {
            const projectsWithDates = filteredData
                .filter(p => p['Date Assigned'])
                .map(project => {
                    const assignedDate = new Date(project['Date Assigned']);
                    const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                    
                    return {
                        label: project['NTP Number'] || 'Unknown',
                        start: assignedDate,
                        progress: completion,
                        supervisor: project['Assigned Supervisor'] || 'Unassigned'
                    };
                })
                .sort((a, b) => a.start - b.start)
                .slice(0, 10); // Show only first 10 projects

            const ctx = document.getElementById('ganttChart').getContext('2d');
            
            if (charts.ganttChart) {
                charts.ganttChart.destroy();
            }

            const labels = projectsWithDates.map(p => p.label);
            const progressData = projectsWithDates.map(p => p.progress);

            charts.ganttChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Progress %',
                        data: progressData,
                        backgroundColor: progressData.map(p => 
                            p >= 100 ? '#10b981' : 
                            p >= 50 ? '#3b82f6' : 
                            p >= 25 ? '#f59e0b' : '#ef4444'
                        ),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Completion %'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Monthly projects chart
        function updateMonthlyProjectsChart() {
            const monthlyData = {};
            
            filteredData.forEach(project => {
                const dateStr = project['Date Assigned'] || '';
                if (dateStr) {
                    try {
                        const date = new Date(dateStr);
                        if (!isNaN(date.getTime())) {
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            const displayKey = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
                            if (!monthlyData[monthKey]) {
                                monthlyData[monthKey] = { count: 0, display: displayKey };
                            }
                            monthlyData[monthKey].count += 1;
                        }
                    } catch (e) {
                        // Skip invalid dates
                    }
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => monthlyData[key].display);
            const projectCounts = sortedMonths.map(key => monthlyData[key].count);

            const ctx = document.getElementById('monthlyProjectsChart').getContext('2d');
            
            if (charts.monthlyProjectsChart) {
                charts.monthlyProjectsChart.destroy();
            }

            charts.monthlyProjectsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projects Started',
                        data: projectCounts,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Completion trends chart
        function updateCompletionTrendsChart() {
            const completionData = {
                '0-25%': 0,
                '26-50%': 0,
                '51-75%': 0,
                '76-99%': 0,
                '100%': 0
            };

            filteredData.forEach(project => {
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                if (completion === 0) completionData['0-25%']++;
                else if (completion <= 25) completionData['0-25%']++;
                else if (completion <= 50) completionData['26-50%']++;
                else if (completion <= 75) completionData['51-75%']++;
                else if (completion < 100) completionData['76-99%']++;
                else completionData['100%']++;
            });

            const ctx = document.getElementById('completionTrendsChart').getContext('2d');
            
            if (charts.completionTrendsChart) {
                charts.completionTrendsChart.destroy();
            }

            charts.completionTrendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(completionData),
                    datasets: [{
                        label: 'Number of Projects',
                        data: Object.values(completionData),
                        backgroundColor: [
                            '#ef4444',
                            '#f59e0b', 
                            '#3b82f6',
                            '#8b5cf6',
                            '#10b981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Scatter chart
        function updateScatterChart() {
            const scatterData = filteredData.map(project => {
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                return { x: cost, y: completion };
            }).filter(point => point.x > 0);

            const ctx = document.getElementById('scatterChart').getContext('2d');
            
            if (charts.scatterChart) {
                charts.scatterChart.destroy();
            }

            charts.scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Projects',
                        data: scatterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgb(59, 130, 246)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Cost ($)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Completion (%)'
                            },
                            min: 0,
                            max: 100
                        }
                    },
                    animation: {
                        duration: 1500
                    }
                }
            });
        }

        // Radar chart
        function updateRadarChart() {
            const supervisorPerformance = {};
            
            filteredData.forEach(project => {
                const supervisor = project['Assigned Supervisor'] || 'Unassigned';
                if (!supervisorPerformance[supervisor]) {
                    supervisorPerformance[supervisor] = {
                        projectCount: 0,
                        totalCost: 0,
                        completedProjects: 0,
                        avgFootage: 0,
                        totalCompletion: 0
                    };
                }
                
                const perf = supervisorPerformance[supervisor];
                perf.projectCount += 1;
                
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;
                perf.totalCost += cost;
                
                const footage = parseFloat((project['Footage UG'] || '0').replace(/[",]/g, '')) || 0;
                perf.avgFootage += footage;
                
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                perf.totalCompletion += completion;
                
                if (project['Constuction Status'] === 'Completed') {
                    perf.completedProjects += 1;
                }
            });

            // Show all supervisors (excluding Unassigned) unless there are too many
            const allSupervisors = Object.entries(supervisorPerformance)
                .filter(([name, _]) => name !== 'Unassigned')
                .sort(([,a], [,b]) => b.projectCount - a.projectCount);

            // Limit to top 6 supervisors if there are too many for readability
            const supervisorsToShow = allSupervisors.slice(0, 6);

            if (supervisorsToShow.length === 0) {
                return;
            }

            const maxValues = {
                projectCount: Math.max(...Object.values(supervisorPerformance).map(p => p.projectCount)),
                totalCost: Math.max(...Object.values(supervisorPerformance).map(p => p.totalCost)),
                completionRate: 100,
                avgCompletion: Math.max(...Object.values(supervisorPerformance).map(p => p.projectCount > 0 ? p.totalCompletion / p.projectCount : 0))
            };

            const colors = [
                'rgba(59, 130, 246, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(245, 158, 11, 0.6)',
                'rgba(139, 92, 246, 0.6)', 'rgba(236, 72, 153, 0.6)', 'rgba(34, 197, 94, 0.6)'
            ];
            const borderColors = [
                'rgb(59, 130, 246)', 'rgb(16, 185, 129)', 'rgb(245, 158, 11)',
                'rgb(139, 92, 246)', 'rgb(236, 72, 153)', 'rgb(34, 197, 94)'
            ];

            const datasets = supervisorsToShow.map(([name, perf], index) => {
                const completionRate = perf.projectCount > 0 ? (perf.completedProjects / perf.projectCount) * 100 : 0;
                const avgCompletion = perf.projectCount > 0 ? perf.totalCompletion / perf.projectCount : 0;
                
                return {
                    label: name,
                    data: [
                        (perf.projectCount / maxValues.projectCount) * 100,
                        (perf.totalCost / maxValues.totalCost) * 100,
                        completionRate,
                        (avgCompletion / maxValues.avgCompletion) * 100
                    ],
                    backgroundColor: colors[index % colors.length],
                    borderColor: borderColors[index % borderColors.length],
                    borderWidth: 2
                };
            });

            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (charts.radarChart) {
                charts.radarChart.destroy();
            }

            charts.radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Project Volume', 'Total Cost', 'Completion Rate', 'Avg Progress'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    animation: {
                        duration: 2000
                    }
                }
            });
        }

        // Supervisor performance chart
        function updateSupervisorPerformanceChart() {
            const supervisorStats = {};
            
            filteredData.forEach(project => {
                const supervisor = project['Assigned Supervisor'] || 'Unassigned';
                if (!supervisorStats[supervisor]) {
                    supervisorStats[supervisor] = { 
                        projects: 0, 
                        totalCompletion: 0, 
                        completedProjects: 0 
                    };
                }
                
                supervisorStats[supervisor].projects += 1;
                const completion = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                supervisorStats[supervisor].totalCompletion += completion;
                
                if (project['Constuction Status'] === 'Completed') {
                    supervisorStats[supervisor].completedProjects += 1;
                }
            });

            const supervisors = Object.keys(supervisorStats).filter(s => s !== 'Unassigned');
            const avgCompletionRates = supervisors.map(supervisor => {
                const stats = supervisorStats[supervisor];
                return stats.projects > 0 ? stats.totalCompletion / stats.projects : 0;
            });

            const ctx = document.getElementById('supervisorPerformanceChart').getContext('2d');
            
            if (charts.supervisorPerformanceChart) {
                charts.supervisorPerformanceChart.destroy();
            }

            charts.supervisorPerformanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: supervisors,
                    datasets: [{
                        label: 'Avg Completion Rate %',
                        data: avgCompletionRates,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Efficiency chart
        function updateEfficiencyChart() {
            const efficiencyData = {
                labels: ['Cost Efficiency', 'Time Efficiency', 'Quality Score', 'Resource Utilization'],
                datasets: [{
                    label: 'Efficiency Metrics',
                    data: [85, 72, 90, 78], // Sample efficiency scores
                    backgroundColor: [
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(139, 92, 246, 0.8)'
                    ],
                    borderColor: [
                        'rgb(59, 130, 246)',
                        'rgb(16, 185, 129)',
                        'rgb(245, 158, 11)',
                        'rgb(139, 92, 246)'
                    ],
                    borderWidth: 2
                }]
            };

            const ctx = document.getElementById('efficiencyChart').getContext('2d');
            
            charts.efficiencyChart = new Chart(ctx, {
                type: 'radar',
                data: efficiencyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update projects table
        function updateTable() {
            const tbody = document.getElementById('projectsTable');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center; color: #6b7280; font-style: italic; padding: 40px;">No project data available. Please upload a CSV file or click Refresh to load data.</td>`;
                tbody.appendChild(row);
                return;
            }

            filteredData.slice(0, 50).forEach(project => {
                const row = document.createElement('tr');
                const completionPercent = parseFloat((project['UG Percentage Complete'] || '0%').replace('%', '')) || 0;
                const cost = parseFloat((project['SOW Estimated Cost'] || '0').replace(/[",]/g, '')) || 0;

                row.innerHTML = `
                    <td>${project['NTP Number'] || ''}</td>
                    <td>${project['AREA'] || ''}</td>
                    <td>${project['Assigned Supervisor'] || ''}</td>
                    <td>${project['Vendor Assignment'] || ''}</td>
                    <td>${formatCurrency(cost)}</td>
                    <td><span class="status-badge ${getStatusClass(project['Constuction Status'])}">${project['Constuction Status'] || ''}</span></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="progress-bar">
                                <div class="progress-fill ${getProgressClass(completionPercent)}" style="width: ${Math.min(completionPercent, 100)}%"></div>
                            </div>
                            <span style="font-size: 12px;">${project['UG Percentage Complete'] || '0%'}</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (filteredData.length > 50) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center; color: #6b7280; font-style: italic;">Showing first 50 of ${filteredData.length} projects. Use filters to refine results.</td>`;
                tbody.appendChild(row);
            }
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch (status) {
                case 'Completed': return 'status-completed';
                case 'In Process': return 'status-process';
                case 'Not Started': return 'status-not-started';
                default: return 'status-other';
            }
        }

        // Get progress CSS class
        function getProgressClass(percent) {
            if (percent >= 70) return 'progress-high';
            if (percent >= 30) return 'progress-medium';
            return 'progress-low';
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadStatus = document.getElementById('uploadStatus');
            const errorMessage = document.getElementById('errorMessage');
            
            uploadStatus.style.display = 'inline';
            errorMessage.style.display = 'none';

            try {
                const fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                    // Handle Excel file
                    const arrayBuffer = await file.arrayBuffer();
                    await parseExcelData(arrayBuffer);
                } else {
                    // Handle CSV/TSV file
                    const text = await file.text();
                    await parseCSVData(text);
                }
                
                updateLastUpdated();
                updateFilters();
                updateDashboard();
                
                errorMessage.style.display = 'block';
                errorMessage.style.background = '#d1fae5';
                errorMessage.style.color = '#065f46';
                errorMessage.textContent = `‚úÖ Successfully loaded ${currentData.length} projects from uploaded file`;
                
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                uploadStatus.style.display = 'none';
                event.target.value = '';
            }
        }

        // Export data to CSV
        function exportData() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = Object.keys(filteredData[0]);
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => 
                    headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tillman-projects-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Utility functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(num) {
            return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>